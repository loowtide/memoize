#! /usr/bin/env python3

import time
from rich.progress import Progress, BarColumn, TaskProgressColumn
import datetime
from datetime import date
from rich.table import Table
from rich.columns import Columns
from rich.panel import Panel
from rich import print
from rich.text import Text
from rich import box
from rich.rule import Rule
from rich.console import Console
import csv
import argparse
from pathlib import Path
from dotenv import load_dotenv
import os
import getpass
import requests
import json

help_msg = """
"""


class Color:
    PURPLE = "\033[95m"
    CYAN = "\033[96m"
    BLUE = "\033[94m"
    GREEN = "\033[92m"
    YELLOW = "\033[93m"
    RED = "\033[91m"
    BOLD = "\033[1m"
    END = "\033[0m"


class Dashboard:
    """
    Dashboard for viewing progress
    """

    HEADER = """
▓▓▓    ▓▓▓ ▓▓▓▓▓▓▓ ▓▓▓    ▓▓▓  ▓▓▓▓▓▓  ▓▓ ▓▓▓▓▓▓▓ ▓▓▓▓▓▓▓ 
▓▓▓▓  ▓▓▓▓ ▓▓      ▓▓▓▓  ▓▓▓▓ ▓▓    ▓▓ ▓▓    ▓▓▓  ▓▓      
▓▓ ▓▓▓▓ ▓▓ ▓▓▓▓▓   ▓▓ ▓▓▓▓ ▓▓ ▓▓    ▓▓ ▓▓   ▓▓▓   ▓▓▓▓▓   
▓▓  ▓▓  ▓▓ ▓▓      ▓▓  ▓▓  ▓▓ ▓▓    ▓▓ ▓▓  ▓▓▓    ▓▓      
▓▓      ▓▓ ▓▓▓▓▓▓▓ ▓▓      ▓▓  ▓▓▓▓▓▓  ▓▓ ▓▓▓▓▓▓▓ ▓▓▓▓▓▓▓
    """
    totalNum = 0
    revised = 0
    console = Console()

    def __init__(self):
        self.console.clear()
        self.file_path = Setup.profile_path

    @classmethod
    def draw_header(cls):
        for line in cls.HEADER.splitlines():
            cls.console.print(f"[bold  red]{line}[/bold  red]")
            time.sleep(0.05)
        time.sleep(0.2)
        cls.console.print(Rule("v0.1.0", style="bold magenta", characters="━"))
        cls.count_revised()
        cls.print_profile()

    @classmethod
    def make_profile(cls):
        with cls.console.status("Fetching...", spinner="arc"):
            query = """
                        query getUserData($username: String!) {
                        profile: matchedUser(username: $username) {
                        username
                        profile {
                        ranking
                        realName
                        }
                        }
                        langs: matchedUser(username: $username) {
                        languageProblemCount {
                        languageName
                        problemsSolved
                            }
                        }
                        problems:matchedUser(username:$username){
                         problemsSolvedBeatsStats {
                          difficulty
                          percentage
                                    }   
                        submitStatsGlobal {
                          acSubmissionNum {
                            difficulty
                            count
                              }
                            }
                                }
                    }
                   """
        payload = {"query": query, "variables": {"username": Setup.USERNAME}}
        response = requests.post(
            Setup.url, cookies=Setup.cookie, headers=Setup.headers, json=payload
        )
        data = response.json().get("data", {})
        with open(Setup.profile_path, "w") as f:
            json.dump(data, f, indent=4)
        with open(Setup.profile_path, "r") as f:
            data = json.load(f)

    @classmethod
    def count_revised(cls):
        cls.totalNum = 0
        cls.revised = 0
        try:
            with open(Setup.csv_path, "r") as f:
                reader = csv.DictReader(f)
                for row in reader:
                    cls.totalNum += 1
                    if row["revised"] == "Yes":
                        cls.revised += 1
        except FileNotFoundError as e:
            print(f"[bold red]File not found: {e}[/bold red]")

    @classmethod
    def print_profile(cls):
        with open(Setup.profile_path, "r") as f:
            data = json.load(f)
            profile_info = data["profile"]

        try:
            mtime = os.path.getmtime(Setup.profile_path)
            last_updated = datetime.datetime.fromtimestamp(mtime).strftime(
                "%Y-%m-%d %H:%M:%S"
            )

            with open(Setup.profile_path, "r") as f:
                data = json.load(f)

        except FileNotFoundError:
            cls.console.print(
                f"[bold red]Error:[/] File '{Setup.profile_path}' not found."
            )
            return

        header_text = Text.assemble(
            ("User: ", "bold white"),
            (f"{profile_info['username']} ", "bold cyan"),
            ("| Ranking: ", "bold white"),
            (f"{profile_info['profile']['ranking']:,}", "bold yellow"),
        )
        cls.console.print(Panel.fit(header_text, style="blue"))

        lang_table = Table(title="Languages Used", border_style="magenta")
        lang_table.add_column("Language", style="cyan")
        lang_table.add_column("Solved", style="green", justify="right")
        for lang in data["langs"]["languageProblemCount"]:
            lang_table.add_row(lang["languageName"], str(lang["problemsSolved"]))

        stats_table = Table(title="Difficulty Stats", border_style="green")
        stats_table.add_column("Difficulty", style="bold")
        stats_table.add_column("Solved", justify="right")
        stats_table.add_column("Beats %", justify="right")

        beats = {
            item["difficulty"]: item["percentage"]
            for item in data["problems"]["problemsSolvedBeatsStats"]
        }
        counts = {
            item["difficulty"]: item["count"]
            for item in data["problems"]["submitStatsGlobal"]["acSubmissionNum"]
        }

        for diff in ["Easy", "Medium", "Hard"]:
            pct_val = beats.get(diff)
            percentage = f"{pct_val}%" if pct_val is not None else "0%"
            count = str(counts.get(diff, 0))
            color = (
                "green" if diff == "Easy" else "yellow" if diff == "Medium" else "red"
            )
            stats_table.add_row(f"[{color}]{diff}[/]", count, percentage)

        mini_progress = Progress(
            BarColumn(bar_width=20),
            TaskProgressColumn(),
        )
        mini_progress.add_task("", total=cls.totalNum, completed=cls.revised)
        revised_table = Table(title="Revised Questions", border_style="magenta")
        revised_table.add_column("Metric", style="bold")
        revised_table.add_column("Value", justify="right")
        revised_table.add_column("Visual Progress")
        revised_table.add_row(
            "Overall Mastery", f"{cls.revised}/{cls.totalNum}", mini_progress
        )
        #       revised_table.add_row(str(self.totalNum), str(self.revised))

        cls.console.print(Columns([lang_table, stats_table, revised_table], equal=True))

        footer_text = Text(
            f"Data Source: {Setup.profile_path} | Last Updated: {last_updated}",
            style="dim italic white",
        )
        Daily.get_question()
        cls.console.print(Panel.fit(footer_text, border_style="dim"))


class Questions:
    """Questions csv"""

    def __init__(self):
        self.get_solved()

    @classmethod
    def get_solved(cls):
        payload = {
            "query": "query userProgressQuestionList($filters: UserProgressQuestionListInput) { userProgressQuestionList(filters: $filters) { totalNum questions { frontendId title  titleSlug questionStatus } } }",
            "variables": {"filters": {"skip": 0, "limit": 4000}},
        }
        response = requests.post(
            Setup.url, cookies=Setup.cookie, headers=Setup.headers, json=payload
        )
        data = response.json()
        listing = data.get("data", {}).get("userProgressQuestionList", {})
        questions = listing["questions"]
        num = listing["totalNum"]
        cls.__make_csv(num, questions)

    @staticmethod
    def __make_csv(num, question):
        file_path = Setup.create_columns()
        ids = set()

        if os.path.exists(file_path):
            with open(file_path, "r", encoding="utf-8") as f:
                reader = csv.DictReader(f)
                for row in reader:
                    if row.get("frontendId"):
                        ids.add(str(row.get("frontendId")))
        with open(file_path, "a", newline="", encoding="utf-8") as f:
            writer = csv.DictWriter(f, Setup.columns, extrasaction="ignore")
            # writer.writeheader()
            for record in question:
                fid = str(record.get("frontendId"))
                if record.get("questionStatus") == "SOLVED" and fid not in ids:
                    row = record.copy()
                    row["link"] = f"https://leetcode.com/{row['titleSlug']}"
                    row["priority"] = str(num)
                    num -= 1
                    row["notes"] = ""
                    row["revised"] = "No"
                    writer.writerow(row)
                    ids.add(fid)


class Daily:
    """
    Remind each to revise for a daily question
    """

    done = "n"

    def __init__(self, done="n"):
        Daily.done = "y" if done == "y" else "n"
        Dashboard.make_profile()
        self.get_question()

    @classmethod
    def get_question(cls):
        rows = []
        with open(Setup.csv_path, "r", encoding="utf-8") as f:
            reader = csv.DictReader(f)
            rows = list(reader)
        target_rows = [r for r in rows if r.get("revised") == "No"]
        if not target_rows:
            print("[bold red]No data found[/bold red]")
            return
        min_row = min(target_rows, key=lambda x: int(x.get("priority")))
        title = min_row["title"]
        link = min_row["link"]
        notes = min_row["notes"]
        today_str = str(date.today())

        if not Setup.profile_path.exists():
            data = {
                "daily": {
                    "title": title,
                    "link": link,
                    "notes": notes,
                    "date": today_str,
                }
            }
        else:
            with open(Setup.profile_path, "r") as f:
                data = json.load(f)

            curr = data.get("daily", {})
            if curr.get("date") != today_str:
                data["daily"] = {
                    "title": title,
                    "link": link,
                    "notes": notes,
                    "date": today_str,
                }
            else:
                title = curr.get("title")
                link = curr.get("link")
                notes = curr.get("notes")

        with open(Setup.profile_path, "w") as f:
            json.dump(data, f, indent=4)

        if cls.done == "y":
            min_row["revised"] = "Yes"
            priority = int(min_row["priority"])
            min_row["priority"] = str(priority + 1)
            with open(Setup.csv_path, "w", newline="", encoding="utf-8") as f:
                writer = csv.DictWriter(f, fieldnames=Setup.columns)
                writer.writeheader()
                writer.writerows(rows)

        content = (
            Text("Title: ", style="bold yellow")
            + Text(f"{title}\n", style="green")
            + Text("Link:  ", style="bold orange3")
            + Text(f"{link}\n", style="underline blue")
            + Text("Notes: ", style="bold red")
            + Text(f"{notes}", style="white")
        )
        print(
            Panel.fit(
                content, title="Today's Question", box=box.HEAVY, border_style="#c4a7e7"
            )
        )


class Notes:
    """
    Adding notes to LeetCode questions
    """

    def __init__(self):
        Questions.get_solved()
        self.add_notes_last()

    def add_notes_last(self):
        console = Console()
        rows = []
        with open(Setup.csv_path, "r", encoding="utf-8") as f:
            reader = csv.DictReader(f)
            rows = list(reader)
        console.print(f"[bold purple]{rows[0]['title']}[/bold purple]")
        notes = console.input("[green]Enter notes[/green]\n")
        if rows:
            if rows[0]:
                rows[0]["notes"] += "\n" + notes
            else:
                rows[0]["notes"] = notes
        with open(Setup.csv_path, "w", newline="", encoding="utf-8") as f:
            writer = csv.DictWriter(f, fieldnames=Setup.columns)
            writer.writeheader()
            writer.writerows(rows)


class Setup:
    base_dir = os.path.dirname(os.path.abspath(__file__))
    csv_path = Path(os.path.join(base_dir, "leetnotes.csv"))
    profile_path = Path(os.path.join(base_dir, "profile.json"))
    columns = ["frontendId", "title", "link", "notes", "priority", "revised"]
    num = None

    USERNAME = None
    LEETCODE_SESSION = None
    csrftoken = None
    url = None
    cookie = None
    headers = None

    def __init__(self):
        self.init_env()
        self.make_request()
        self.create_columns()
        Dashboard.make_profile()

    @classmethod
    def make_request(cls):
        cls.url = "https://leetcode.com/graphql"
        cls.cookie = {
            "LEETCODE_SESSION": Setup.LEETCODE_SESSION,
            "csrftoken": Setup.csrftoken,
        }
        cls.headers = {
            "Content-Type": "application/json",
            "Referer": "https://leetcode.com",
            "X-CSRFToken": Setup.csrftoken,
        }

    @classmethod
    def create_columns(cls):
        if not cls.csv_path.exists():
            with open(cls.csv_path, "w", newline="", encoding="utf-8") as f:
                writer = csv.DictWriter(f, Setup.columns)
                writer.writeheader()
        return cls.csv_path

    @classmethod
    def init_env(cls):
        env_path = Path(__file__).resolve().parent / ".env"
        if env_path.exists():
            load_dotenv(dotenv_path=env_path)
            cls.LEETCODE_SESSION = os.getenv("LEETCODE_SESSION")
            cls.csrftoken = os.getenv("csrftoken")
            cls.USERNAME = os.getenv("USERNAME")
        else:
            session = getpass.getpass(
                f"{Color.BOLD}{Color.GREEN}Enter LEETCODE_SESSION:{Color.END}\n"
            )
            token = getpass.getpass(
                f"{Color.BOLD}{Color.GREEN}Enter csrftoken:{Color.END}\n"
            )
            username = input(f"{Color.BLUE}Enter username:\n{Color.END}")
            with open(env_path, "w") as f:
                f.write(f'LEETCODE_SESSION="{session}"\n')
                f.write(f'csrftoken="{token}"\n')
                f.write(f'USERNAME="{username}"\n')
            cls.LEETCODE_SESSION = session
            cls.csrftoken = token
            cls.USERNAME = username


def main():
    Setup()
    # Questions()
    parser = argparse.ArgumentParser(add_help=True)
    subparser = parser.add_subparsers(dest="command")
    subparser.add_parser("dashboard", help="Open Dashboard")
    subparser.add_parser("note", help="Open last accepted question for notes")
    parser.add_argument("-t", "--today", nargs="?", const="n", default=None)
    parser.add_argument("-d", "--dashboard", action="store_true")
    parser.add_argument("-n", "--note", action="store_true")
    args = parser.parse_args()
    if any([args.command == "dashboard", args.dashboard]):
        Dashboard.draw_header()
    if args.today is not None:
        Daily(args.today)
    elif args.note:
        Notes()


if __name__ == "__main__":
    main()
